---
title: " OmexdiaCalibration Tool Box: Minimal Example"
author: "Arthur Capet"
date: "Nov, 2017"
output: 
#  pdf_document:
#    toc: yes
  #slidy_presentation:
  #  toc: yes
  github_document:
    toc: yes
urlcolor: blue
---

```{r global_options, include=FALSE}
rm(list=ls()) ### To clear namespace
library(knitr)
opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
               echo=TRUE, warning=FALSE, message=FALSE)
```


 This script loads all the auxiliary functions, and runs + display a first simulation.
 It then provides an example of how to load data, compute model misfits for specific variables, 
 and display the comparison with model ouptuts

```{r}
# Loading OmexCal functions
source("OmexCal_Load.R")
```

# Example of use

The global variable `parSta` is used inside auxiliary functions.
It contains the full parameter list as given in "OMEXDIA_OG3_BasicSetup.R"

```{r}
# local copy of the global parameter vector
parSta<-pars

# OCALL gets the model solution for parameters given in argument
DIA <-OCALL(parSta)

# Display can be done directly with parameters value
Simplot(pars)

# .. or with model outputs -> TO UPDATE
# Simplot(DIA)

```

#  User Data

User data are to be stored in a .xls file, respecitng the [user data file structure](datastructure.md).
User-specific options (eg. filepahts, etc ..) are to be given in a file like (UsersDefinitions_HAMMOND.R)[UsersDefinitions_HAMMOND.R]

```{r}
source('UsersDefinitions_HAMMOND.R')
sta<-"H2"
cam<-"Sep89"

#source('UsersDefinitions_NOAH.R')
#sta<-"C"
#cam<-"HE432"

# This loads data the based on info given in the UserDefinitions....R
source('OmexCal_Load_Data.R')


# We then create "local" dataframes, specific to one station.
localdata    <- subset(dfProfiles, Station==sta & Campaign == cam)
localdatafl  <- subset(dfFluxes,   Station==sta & Campaign == cam)
localdatasta <- subset(dfStations, Station==sta & Campaign == cam)
```

Some parameters are general, some have to ba adapted for each station/campaign.
This is the case, for instance, of the porosity grid and bottom water concentration for nutrients.

```{r}
# In addition, some global parameters have to be given a local (station+campagin) value
parSta    <- OmexCal_AdaptForSta()

ggplot(localdata,
       aes(x=value,y=UpperDepth/2+LowerDepth/2,
             ymax=UpperDepth,ymin=LowerDepth,
             xmin=value-err, xmax=value+err))+
  geom_errorbar()+
  geom_errorbarh()+
  geom_point(size=2)+
  facet_wrap(~variable,scales = "free")+ylim(c(30,0))

```

# Modal-Data metrics

Once data are loaded, the generic cost function can be used while specifying which data should be used to asess the model skills.
```{r}
#  Cost function can be called with a list of profile variables and a list of flux variables
 C1 <- OCOST_GEN(pars,Vlist = "NH3")
 C1$var

 C2 <- OCOST_GEN(parSta,Vlist = "NH3")
 C2$var
 
 C3 <- OCOST_GEN(parSta,Vlist = c("NOx","PO4","NH3"))
 C3$var
 
 C4 <- OCOST_GEN(parSta,Vlist = c("NH3","DIC"), Flist = c("SIO","NH3","NOx"))
 C4$var
```

# Display 

The toolbox then contains a number of function to display model outputs and usefull summary tables.
```{r}
# Some result display script, first one by one : 
Simplot(pars,plotdata=TRUE)+        # The flag TRUE is used to disaply the data along model ouputs
  ggtitle(paste(sta,"0. No Fit"))

partableplot(pars)

fluxtable(pars)$p

# Collect all on the same plot
grid.arrange(Simplot(parSta,TRUE)+ggtitle(paste(sta,"1. Pseudo")),
             arrangeGrob(partableplot(parSta)),
             arrangeGrob(fluxtable(parSta)$p,
                         fittableplot(C3),ncol=1,heights=c(6,4)),
             ncol = 3,nrow=1, widths=c(5*3,7,3), heights = c(12))
```

